{% extends 'base.html' %}
{% block title %}âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‚Ø§Ù„ - tecBamin{% endblock %}
{% block content %}
<div class="container my-4">
  <div class="card shadow-sm border-0">
    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
      <h5 class="mb-0">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ù„</h5>
      <a href="{{ url_for('main.dashboard') }}" class="btn btn-light btn-sm">ğŸ”™ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
    </div>
    <div class="card-body">
      <form method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
        <div class="mb-3">
          {{ form.title.label(class="form-label") }}
          {{ form.title(class="form-control", placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‚Ø§Ù„") }}
        </div>
        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
        <div class="mb-3">
          <label class="form-label">Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù‚Ø§Ù„</label>
          <div class="d-flex justify-content-between align-items-center mb-1">
            <small class="text-muted">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„ØµÙˆØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù‚Ø§Ù„</small>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('imageInput').click()">ğŸ“· Ø¥Ø¯Ø±Ø§Ø¬ ØµÙˆØ±Ø©</button>
          </div>
          {{ form.content(class="form-control", rows="8", placeholder="Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù‚Ø§Ù„") }}
        </div>
        <!-- Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
        {% if article.image_path %}
        <div class="mb-3">
          <label class="form-label">ğŸ“¸ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</label><br>
          <img src="{{ url_for('static', filename='uploads/' ~ article.image_path) }}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù‚Ø§Ù„" class="img-fluid rounded shadow-sm mb-2" style="max-width: 300px;" loading="lazy">
          <div class="form-check mt-2">
            {{ form.remove_image(class="form-check-input", id="remove_image") }}
            <label class="form-check-label" for="remove_image">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
          </div>
        </div>
        {% endif %}
        <!-- Ø§Ù„ØªØµÙ†ÙŠÙ -->
        <div class="mb-3">
          {{ form.category.label(class="form-label") }}
          {{ form.category(class="form-select") }}
        </div>
        <!-- ÙƒØ§ØªØ¨ Ø§Ù„Ù…Ù‚Ø§Ù„ -->
        <div class="mb-3">
          {{ form.author.label(class="form-label") }}
          {{ form.author(class="form-select") }}
        </div>
        <!-- Ø§Ù„ØªØ§Ø¬Ø² -->
        <div class="mb-3">
          {{ form.tags.label(class="form-label") }}
          {{ form.tags(class="form-control", placeholder="Ù…Ø«Ø§Ù„: Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ, Ø¨Ø§ÙŠØ«ÙˆÙ†") }}
          <div class="form-text">Ø§ÙØµÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙØ§ØµÙ„Ø© (,)</div>
        </div>
        <!-- Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© -->
        <div class="mb-3">
          {{ form.related_articles.label(class="form-label") }}
          {{ form.related_articles(id="related_articles", multiple=True) }}
          <div class="form-text">Ø§Ø®ØªØ± Ù…Ù‚Ø§Ù„ Ø£Ùˆ Ø£ÙƒØ«Ø± Ù„Ø±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ù…Ù‚Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
        </div>
        <!-- Ø®ÙŠØ§Ø± Ø§Ù„Ù†Ø´Ø± -->
        <div class="form-check mb-3">
          {{ form.is_published(class="form-check-input", id="is_published") }}
          {{ form.is_published.label(class="form-check-label", for="is_published") }}
        </div>
        <!-- Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© -->
        <div class="mb-3">
          {{ form.image.label(class="form-label") }}
          {{ form.image(class="form-control") }}
          <div class="form-text">ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ (jpg, png)</div>
        </div>
        <!-- Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© -->
        <div class="mb-3">
          {{ form.image_url.label(class="form-label") }}
          {{ form.image_url(class="form-control", placeholder="https://example.com/image.jpg") }}
          <div class="form-text">Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
        </div>
        <!-- Ø²Ø± Ø§Ù„Ø­ÙØ¸ -->
        <div class="d-grid mt-4">
          {{ form.submit(class="btn btn-warning") }}
        </div>
      </form>
    </div>
  </div>
</div>
<!-- input Ù…Ø®ÙÙŠ Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù‚Ø§Ù„ -->
<input type="file" id="imageInput" accept="image/*" hidden>
<!-- Ø³ÙƒØ±Ø¨Øª Ø¥Ø¯Ø±Ø§Ø¬ ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
<script>
  const imageInput = document.getElementById('imageInput');
  const contentField = document.querySelector('textarea[name="content"]');
  
  imageInput.addEventListener('change', async function () {
    const file = this.files[0];
    if (!file) return;
  
    const formData = new FormData();
    formData.append('image', file);
  
    try {
      const response = await fetch('/upload_image', {
        method: 'POST',
        body: formData
      });
  
      const data = await response.json();
  
      if (data.success) {
        const imgTag = `<img src="${data.url}" alt="${file.name}" style="max-width:100%; margin:10px auto; border-radius:8px; display:block;">\n`;
        insertAtCursor(contentField, imgTag);
      } else {
        alert('âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©');
      }
    } catch (err) {
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©');
    }
  
    imageInput.value = '';
  });
  
  function insertAtCursor(textarea, text) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const content = textarea.value;
    textarea.value = content.slice(0, start) + text + content.slice(end);
    textarea.focus();
    textarea.selectionStart = textarea.selectionEnd = start + text.length;
  }
</script>
{% endblock %}